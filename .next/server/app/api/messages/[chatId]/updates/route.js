"use strict";(()=>{var e={};e.id=46,e.ids=[46],e.modules={1185:e=>{e.exports=require("mongoose")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7249:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>u,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p});var o={};n.r(o),n.d(o,{GET:()=>m});var r=n(9303),s=n(8716),a=n(670),i=n(7070),c=n(5748),l=n(2671);async function m(e,{params:t}){let{chatId:n}=t,o=e.headers.get("X-Current-User-Id"),{searchParams:r}=new URL(e.url),s=r.get("since");if(console.log(`API UPDATES: ChatID: "${n}", ReqUser: "${o}", Since: "${s}"`),!o||!n||!s)return i.NextResponse.json({success:!1,message:"Missing required parameters (chatId, since, or auth header)."},{status:400});if(!n.includes(o))return i.NextResponse.json({success:!1,message:"Forbidden."},{status:403});try{await (0,c.Z)();let e=(0,l.Z)(n),t=new Date(s);if(isNaN(t.getTime()))return i.NextResponse.json({success:!1,message:'Invalid "since" timestamp format.'},{status:400});let o=(await e.find({timestamp:{$gt:t}}).sort({timestamp:1}).select("_id content timestamp sender senderUsername").lean()).map(e=>({_id:e._id.toString(),content:e.content,timestamp:e.timestamp.toISOString(),fromUserId:e.sender.toString(),fromUsername:e.senderUsername}));return i.NextResponse.json({success:!0,messages:o},{status:200})}catch(e){return console.error(`API UPDATES Error for ${n}:`,e.message),i.NextResponse.json({success:!1,message:"Error fetching message updates."},{status:500})}}let d=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/messages/[chatId]/updates/route",pathname:"/api/messages/[chatId]/updates",filename:"route",bundlePath:"app/api/messages/[chatId]/updates/route"},resolvedPagePath:"/home/sujal/Desktop/buzzly-minimal/src/app/api/messages/[chatId]/updates/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:g}=d,h="/api/messages/[chatId]/updates/route";function f(){return(0,a.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}},5748:(e,t,n)=>{n.d(t,{Z:()=>i});var o=n(1185),r=n.n(o);let s=process.env.MONGODB_URI;if(!s)throw Error("CRITICAL: MONGODB_URI is not defined. Check .env.local or environment config.");let a=global.__buzzly_minimal_mongoose_cache;a||(a=global.__buzzly_minimal_mongoose_cache={conn:null,promise:null});let i=async function(){if(a.conn){if(1===a.conn.readyState)return a.conn;console.warn(`DB: Cached connection readyState is ${a.conn.readyState}. Re-attempting.`),a.conn=null,a.promise=null}a.promise||(console.log("DB: Creating new database connection promise."),a.promise=r().connect(s,{bufferCommands:!1}).then(e=>{console.log("DB: Mongoose connected successfully via new promise!");let t=e.connection;return t.on("error",e=>{console.error("DB: Mongoose connection error event:",e),a.conn=null,a.promise=null}),t.on("disconnected",()=>{console.warn("DB: Mongoose connection disconnected event."),a.conn=null,a.promise=null}),t}).catch(e=>{throw console.error("DB: Initial mongoose.connect() promise rejected:",e.message),a.promise=null,e}));try{console.log("DB: Awaiting connection promise to resolve."),a.conn=await a.promise}catch(e){throw console.error("DB: Error awaiting connection promise:",e.message),a.promise=null,e}if(a.conn&&1===a.conn.readyState)console.log("DB: Connection active after promise resolution.");else throw console.error("DB: Post-promise, connection not active. State:",a.conn?.readyState),Error("DB: Failed to establish an active connection.");return a.conn}},2671:(e,t,n)=>{n.d(t,{Z:()=>a});var o=n(1185),r=n.n(o);let s=new o.Schema({sender:{type:o.Schema.Types.ObjectId,ref:"User",required:!0},senderUsername:{type:String,required:!0,trim:!0},receiver:{type:o.Schema.Types.ObjectId,ref:"User",required:!0},content:{type:String,required:!0,trim:!0},timestamp:{type:Date,default:Date.now},read:{type:Boolean,default:!1}});s.index({timestamp:1},{expireAfterSeconds:259200});let a=e=>{if(!e||"string"!=typeof e||""===e.trim())throw Error("Invalid chat collection identifier provided for chat messages model.");let t=e.replace(/[^a-zA-Z0-9_]/g,"");if(0===t.length)throw Error("Sanitized collection identifier is empty.");let n=`chat_${t}_messages`;return r().models[n]?r().models[n]:r().model(n,s)}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),o=t.X(0,[948,972],()=>n(7249));module.exports=o})();